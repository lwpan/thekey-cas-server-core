<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:lang="http://www.springframework.org/schema/lang"
	xmlns:util="http://www.springframework.org/schema/util"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
	                    http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang-3.0.xsd
	                    http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd">

	<bean id="viewContextFactory" class="org.ccci.gto.cas.services.web.ViewContextFactory">
		<property name="argumentExtractors" ref="argumentExtractors" />
		<property name="servicesManager" ref="servicesManager" />
	</bean>

	<util:list id="viewPopulators">
    <bean class="org.ccci.gto.cas.services.web.RequestUriViewPopulator" />
		<bean class="org.ccci.gto.cas.services.web.MobileViewPopulator">
			<property name="mobileBrowsers">
				<map>
					<entry key=".*iPhone.*" value="iphone" />
					<entry key=".*Android.*" value="iphone" />
					<entry key=".*Safari.*Pre.*" value="iphone" />
					<entry key=".*Nokia.*AppleWebKit.*" value="iphone" />
				</map>
			</property>
		</bean>
		<ref bean="facebook.view.populator" />
    <ref bean="relay.view.populator" />
		<bean class="org.ccci.gto.cas.css.services.web.CssViewPopulator" />
		<bean class="org.ccci.gto.cas.services.web.LanguagesViewPopulator">
			<property name="languages" ref="languages" />
		</bean>
		<bean class="org.ccci.gto.cas.services.web.ServiceViewPopulator" />
		<bean class="org.ccci.gto.cas.selfservice.support.populator.PasswordValidatorViewPopulator">
			<property name="passwordValidator" ref="passwordValidator" />
		</bean>
    <bean class="org.ccci.gto.cas.services.web.GoogleAnalyticsViewPopulator">
      <property name="account" value="${google.analytics.account}" />
    </bean>
	</util:list>

	<bean id="theKeyViewInterceptor" class="org.ccci.gto.cas.services.web.TheKeyViewInterceptor">
		<property name="viewContextFactory" ref="viewContextFactory" />
		<property name="populators" ref="viewPopulators" />
	</bean>

	<bean id="theKeyFlowViewInterceptor" class="org.ccci.gto.cas.services.webflow.execution.TheKeyFlowExecutionListener">
		<property name="viewContextFactory" ref="viewContextFactory" />
		<property name="populators" ref="viewPopulators" />
	</bean>

  <bean id="theKeyViewResolver" class="org.ccci.gto.cas.web.servlet.view.TheKeyViewResolver">
    <property name="order" value="-1" />
    <property name="argumentExtractors" ref="argumentExtractors" />
    <property name="servicesManager" ref="servicesManager" />
  </bean>

	<!-- css scrubber service -->
	<bean id="cssScrubber" class="org.ccci.gto.cas.css.scrubber.ParsingCachingCssScrubber">
		<property name="filters">
			<list>
				<!-- block unknown rules to prevent potential future attacks -->
				<bean class="org.ccci.gto.cas.css.filter.RuleTypeCssFilter">
					<property name="filterType">
						<util:constant static-field="org.ccci.gto.cas.css.filter.ReversibleFilter.Type.BLACKLIST" />
					</property>
					<property name="types">
						<list>
							<util:constant static-field="org.w3c.dom.css.CSSRule.UNKNOWN_RULE" />
						</list>
					</property>
				</bean>
				<!-- block behavior properties which embeds a script that is run -->
				<bean class="org.ccci.gto.cas.css.filter.PropertyNameCssFilter">
					<property name="filterType">
						<util:constant static-field="org.ccci.gto.cas.css.filter.ReversibleFilter.Type.BLACKLIST" />
					</property>
					<property name="names">
						<list>
							<value>behavior</value>
							<value>-mm-behavior</value>
						</list>
					</property>
				</bean>
				<!-- block microsoft ie css expressions -->
				<bean class="org.ccci.gto.cas.css.filter.PropertyValueCssFilter">
					<property name="filterType">
						<util:constant static-field="org.ccci.gto.cas.css.filter.ReversibleFilter.Type.BLACKLIST" />
					</property>
					<property name="values">
						<list>
							<value>expression</value>
						</list>
					</property>
				</bean>
				<bean class="org.ccci.gto.cas.css.filter.AbsoluteUriCssFilter" />
				<bean class="org.ccci.gto.cas.css.filter.FilteredImportCssFilter">
					<property name="filterUri" value="${server.prefix}/css" />
					<property name="filterType">
						<util:constant static-field="org.ccci.gto.cas.css.filter.ReversibleFilter.Type.WHITELIST" />
					</property>
          <property name="uris" ref="trustedCssUris" />
				</bean>
			</list>
		</property>
		<property name="cache">
			<bean class="org.apache.jcs.JCS" factory-method="getInstance">
				<constructor-arg value="cssCache" />
			</bean>
		</property>
	</bean>

  <util:list id="trustedCssUris">
    <value>${server.prefix}/themes/thekey/base.css</value>
    <value>${server.prefix}/themes/thekey/default.css</value>
  </util:list>
</beans>
